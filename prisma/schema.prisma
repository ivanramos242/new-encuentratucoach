generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  coach
  client
}

enum CoachCertificationStatus {
  none
  pending
  approved
  rejected
}

enum CoachProfileStatus {
  draft
  pending_review
  published
  paused
  archived
}

enum CoachVisibilityStatus {
  active
  inactive
}

enum SessionMode {
  online
  presencial
}

enum ReviewCoachDecision {
  pending_coach_review
  approved
  rejected
  flagged
}

enum ReviewAdminDecision {
  none
  approved
  rejected
  override
}

enum CertificationRequestStatus {
  pending
  approved
  rejected
}

enum SubscriptionPlanCode {
  monthly
  annual
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  unpaid
  incomplete
  incomplete_expired
}

enum CoachLinkType {
  web
  linkedin
  instagram
  facebook
  whatsapp
  phone
  email
}

enum ClickTarget {
  whatsapp
  phone
  email
  web
  linkedin
  instagram
  facebook
  mensaje
}

enum ContactLeadStatus {
  received
  emailed
  failed
  spam
}

enum ConversationThreadStatus {
  open
  closed_by_client
  closed_by_coach
  admin_locked
}

enum MessageSenderType {
  client
  coach
  admin_system
}

enum AttachmentType {
  image
  pdf
}

enum AttachmentStatus {
  uploaded
  validated
  rejected
  deleted
}

enum QaQuestionStatus {
  published
  flagged
  hidden
  locked
  deleted
}

enum QaAnswerStatus {
  published
  flagged
  hidden
  deleted
}

enum QaReportTargetType {
  question
  answer
}

enum QaVoteType {
  up
  down
}

enum NotificationType {
  message_new
  message_reply
  message_thread_reported
  qa_question_answered
  qa_answer_accepted
  qa_content_reported
  qa_content_moderated
  review_new_pending
  review_coach_action_required
  subscription_state_changed
  system_announcement
}

enum NotificationChannel {
  in_app
  email
}

enum NotificationDeliveryStatus {
  pending
  sent
  failed
  skipped
}

enum JobType {
  send_email_notification
  retry_email_notification
  recalc_funnel_aggregates
  recalc_qa_counters
  cleanup_orphan_attachments
  expire_notifications
}

enum JobStatus {
  queued
  running
  done
  failed
  dead_letter
}

enum JobPriority {
  low
  normal
  high
}

enum FunnelEventType {
  profile_view
  profile_cta_click
  chat_thread_started
  chat_first_coach_reply
  chat_client_followup
  qa_question_view
  qa_question_created
  qa_answer_created
  qa_answer_accepted
  review_created
  review_approved
}

model User {
  id                  String                   @id @default(cuid())
  email               String                   @unique
  passwordHash        String?
  displayName         String?
  role                UserRole                 @default(client)
  isActive            Boolean                  @default(true)
  mustResetPassword   Boolean                  @default(false)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  sessions            AuthSession[]
  passwordResetTokens PasswordResetToken[]
  emailTokens         EmailVerificationToken[]
  coachProfiles       CoachProfile[]
  reviewsWritten      Review[]                 @relation("UserWrittenReviews")
  reviewAuditLogs     ReviewAuditLog[]
  certificationRequests CertificationRequest[] @relation("CoachCertificationRequests")
  certificationReviews CertificationRequest[]  @relation("CertificationReviewedBy")
  certificationReviewLogs CertificationReviewLog[] @relation("CertificationLogReviewer")
  stripeCustomer      StripeCustomer?
  billingEvents       BillingEventLog[]
  clientConversationThreads ConversationThread[]   @relation("ConversationThreadClient")
  coachConversationThreads  ConversationThread[]   @relation("ConversationThreadCoachUser")
  conversationParticipants  ConversationParticipant[]
  sentConversationMessages  ConversationMessage[]  @relation("ConversationMessageSender")
  conversationReadCursors   ConversationReadCursor[]
  conversationReports       ConversationReport[]   @relation("ConversationReportReporter")
  qaQuestions               QaQuestion[]           @relation("QaQuestionAuthor")
  qaAnswers                 QaAnswer[]             @relation("QaAnswerAuthor")
  qaAnswerVotes             QaAnswerVote[]
  qaReports                 QaReport[]             @relation("QaReportReporter")
  qaModerationLogs          QaModerationLog[]      @relation("QaModerationActor")
  notifications             Notification[]
  notificationPreferences   NotificationPreference[]
  notificationDeliveryAttempts NotificationDeliveryAttempt[] @relation("NotificationDeliveryUser")
  attributionSessions       AttributionSession[]
  funnelEvents              FunnelEvent[]
  jobRunLogs                JobRunLog[]            @relation("JobRunActor")
}

model AuthSession {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailVerificationToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LegacyImportMap {
  id          String   @id @default(cuid())
  sourceSystem String
  sourceType   String
  sourceId     String
  targetTable  String
  targetId     String
  payload      Json?
  createdAt    DateTime @default(now())

  @@unique([sourceSystem, sourceType, sourceId])
}

model CoachLocation {
  id        String        @id @default(cuid())
  city      String
  province  String?
  country   String        @default("Espa√±a")
  slug      String        @unique
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  coaches   CoachProfile[]
}

model CoachCategory {
  id          String               @id @default(cuid())
  slug         String               @unique
  name         String
  description  String?
  isActive     Boolean              @default(true)
  sortOrder    Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  coachLinks   CoachProfileCategory[]
}

model CoachLanguage {
  id          String               @id @default(cuid())
  slug         String               @unique
  name         String
  isActive     Boolean              @default(true)
  sortOrder    Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  coachLinks   CoachProfileLanguage[]
}

model CoachProfile {
  id                   String                    @id @default(cuid())
  userId               String?
  slug                 String                    @unique
  name                 String
  headline             String?
  bio                  String?
  aboutHtml            String?
  gender               String?
  locationId           String?
  certifiedStatus      CoachCertificationStatus  @default(none)
  profileStatus        CoachProfileStatus        @default(draft)
  visibilityStatus     CoachVisibilityStatus     @default(inactive)
  featured             Boolean                   @default(false)
  messagingEnabled     Boolean                   @default(true)
  messagingAutoReply   String?
  messagingReplySlaMinutes Int?
  qaAnswersCount       Int                       @default(0)
  qaAcceptedAnswersCount Int                     @default(0)
  heroImageUrl         String?
  videoPresentationUrl String?
  specialtiesText      String?
  languagesText        String?
  publishedAt          DateTime?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  owner                User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)
  location             CoachLocation?            @relation(fields: [locationId], references: [id], onDelete: SetNull)
  categories           CoachProfileCategory[]
  languages            CoachProfileLanguage[]
  sessionModes         CoachProfileSessionMode[]
  galleryAssets        CoachGalleryAsset[]
  links                CoachLink[]
  pricing              CoachPricing?
  subscriptions        CoachSubscription[]
  reviews              Review[]
  certificationRequests CertificationRequest[]
  viewSessions         CoachProfileViewSession[]
  viewAggregates       CoachProfileViewDailyAggregate[]
  clickEvents          CoachProfileClickEvent[]
  clickAggregates      CoachProfileClickDailyAggregate[]
  contactLeads         CoachContactLead[]
  conversationThreads  ConversationThread[]
  qaAnswers            QaAnswer[]
  funnelEvents         FunnelEvent[]
  funnelAggregates     CoachFunnelDailyAggregate[]
}

model CoachProfileCategory {
  coachProfileId String
  categoryId     String
  createdAt      DateTime      @default(now())
  coachProfile   CoachProfile   @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  category       CoachCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([coachProfileId, categoryId])
}

model CoachProfileLanguage {
  coachProfileId String
  languageId     String
  createdAt      DateTime      @default(now())
  coachProfile   CoachProfile   @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  language       CoachLanguage  @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@id([coachProfileId, languageId])
}

model CoachProfileSessionMode {
  coachProfileId String
  mode           SessionMode
  createdAt      DateTime     @default(now())
  coachProfile   CoachProfile  @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@id([coachProfileId, mode])
}

model CoachGalleryAsset {
  id            String      @id @default(cuid())
  coachProfileId String
  url           String
  alt           String?
  sortOrder     Int         @default(0)
  sourceMediaId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
}

model CoachLink {
  id            String       @id @default(cuid())
  coachProfileId String
  type          CoachLinkType
  label         String?
  value         String
  isPrimary     Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@unique([coachProfileId, type, value])
}

model CoachPricing {
  id            String      @id @default(cuid())
  coachProfileId String     @unique
  basePriceEur  Int?
  currency      String      @default("EUR")
  detailsHtml   String?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
}

model SubscriptionPlan {
  id                 String               @id @default(cuid())
  code               SubscriptionPlanCode @unique
  name               String
  intervalLabel      String
  priceCents         Int
  currency           String               @default("EUR")
  stripePriceId      String?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  coachSubscriptions CoachSubscription[]
}

model StripeCustomer {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeCustomerId String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CoachSubscription {
  id                 String             @id @default(cuid())
  coachProfileId      String
  planId              String?
  planCode            SubscriptionPlanCode
  status              SubscriptionStatus
  stripeSubscriptionId String?          @unique
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean           @default(false)
  graceUntil          DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  coachProfile        CoachProfile      @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  plan                SubscriptionPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  stripeSnapshots     StripeSubscriptionSnapshot[]
  billingEvents       BillingEventLog[]
}

model StripeSubscriptionSnapshot {
  id                  String            @id @default(cuid())
  coachSubscriptionId String?
  stripeSubscriptionId String
  payload             Json
  createdAt           DateTime          @default(now())
  coachSubscription   CoachSubscription? @relation(fields: [coachSubscriptionId], references: [id], onDelete: SetNull)
}

model BillingEventLog {
  id                  String             @id @default(cuid())
  stripeEventId       String?            @unique
  eventType           String
  userId              String?
  coachSubscriptionId String?
  payload             Json?
  processedAt         DateTime?
  createdAt           DateTime           @default(now())
  user                User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  coachSubscription   CoachSubscription? @relation(fields: [coachSubscriptionId], references: [id], onDelete: SetNull)
}

model Review {
  id             String             @id @default(cuid())
  coachProfileId  String
  clientUserId    String
  title          String?
  body           String
  coachDecision  ReviewCoachDecision @default(pending_coach_review)
  adminDecision  ReviewAdminDecision @default(none)
  isVisible      Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  coachProfile   CoachProfile       @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  clientUser     User               @relation("UserWrittenReviews", fields: [clientUserId], references: [id], onDelete: Cascade)
  rating         ReviewRating?
  auditLogs      ReviewAuditLog[]

  @@unique([coachProfileId, clientUserId])
}

model ReviewRating {
  reviewId     String  @id
  overall      Int
  communication Int?
  process      Int?
  results      Int?
  review       Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model ReviewAuditLog {
  id         String   @id @default(cuid())
  reviewId    String
  actorUserId String?
  action     String
  note       String?
  payload    Json?
  createdAt  DateTime @default(now())
  review     Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  actorUser  User?    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
}

model CertificationRequest {
  id             String                   @id @default(cuid())
  coachProfileId  String
  coachUserId     String
  reviewerUserId  String?
  status         CertificationRequestStatus @default(pending)
  coachNotes     String?
  reviewerNotes  String?
  submittedAt    DateTime                 @default(now())
  reviewedAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  coachProfile   CoachProfile             @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  coachUser      User                     @relation("CoachCertificationRequests", fields: [coachUserId], references: [id], onDelete: Cascade)
  reviewerUser   User?                    @relation("CertificationReviewedBy", fields: [reviewerUserId], references: [id], onDelete: SetNull)
  documents      CertificationDocument[]
  logs           CertificationReviewLog[]
}

model CertificationDocument {
  id                    String               @id @default(cuid())
  certificationRequestId String
  storageKey            String
  fileName              String
  mimeType              String
  sizeBytes             Int
  createdAt             DateTime             @default(now())
  certificationRequest  CertificationRequest @relation(fields: [certificationRequestId], references: [id], onDelete: Cascade)
}

model CertificationReviewLog {
  id                    String               @id @default(cuid())
  certificationRequestId String
  reviewerUserId        String?
  decision              CertificationRequestStatus
  note                  String?
  createdAt             DateTime             @default(now())
  certificationRequest  CertificationRequest @relation(fields: [certificationRequestId], references: [id], onDelete: Cascade)
  reviewerUser          User?                @relation("CertificationLogReviewer", fields: [reviewerUserId], references: [id], onDelete: SetNull)
}

model CoachProfileViewSession {
  id            String      @id @default(cuid())
  coachProfileId  String
  sessionKey    String
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  durationSeconds Int?
  ipHash        String?
  userAgent     String?
  createdAt     DateTime    @default(now())
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@unique([coachProfileId, sessionKey])
}

model CoachProfileViewDailyAggregate {
  id                String      @id @default(cuid())
  coachProfileId      String
  date              DateTime    @db.Date
  totalViews        Int         @default(0)
  totalDurationSeconds Int      @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  coachProfile      CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@unique([coachProfileId, date])
}

model CoachProfileClickEvent {
  id            String      @id @default(cuid())
  coachProfileId  String
  target        ClickTarget
  ipHash        String?
  userAgent     String?
  createdAt     DateTime    @default(now())
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
}

model CoachProfileClickDailyAggregate {
  id            String      @id @default(cuid())
  coachProfileId  String
  target        ClickTarget
  date          DateTime    @db.Date
  count         Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coachProfile  CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@unique([coachProfileId, target, date])
}

model BlogCategory {
  id        String     @id @default(cuid())
  slug      String     @unique
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  posts     BlogPost[]
}

model BlogPost {
  id              String      @id @default(cuid())
  slug            String      @unique
  title           String
  excerpt         String?
  contentHtml     String?
  seoTitle        String?
  seoDescription  String?
  coverImageUrl   String?
  isPublished     Boolean     @default(false)
  publishedAt     DateTime?
  categoryId      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  category        BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags            BlogPostTag[]
}

model BlogTag {
  id        String      @id @default(cuid())
  slug      String      @unique
  name      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  posts     BlogPostTag[]
}

model BlogPostTag {
  blogPostId String
  blogTagId  String
  blogPost   BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  blogTag    BlogTag  @relation(fields: [blogTagId], references: [id], onDelete: Cascade)

  @@id([blogPostId, blogTagId])
}

model FaqItem {
  id          String   @id @default(cuid())
  slug        String?  @unique
  question    String
  answerHtml  String
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SeoMetaOverride {
  id              String   @id @default(cuid())
  routePath       String   @unique
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?
  noindex         Boolean  @default(false)
  schemaJson      Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RedirectRule {
  id          String   @id @default(cuid())
  sourcePath  String   @unique
  destinationPath String
  statusCode  Int      @default(301)
  isActive    Boolean  @default(true)
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CoachContactLead {
  id            String           @id @default(cuid())
  coachProfileId  String
  name          String
  email         String
  message       String
  status        ContactLeadStatus @default(received)
  errorMessage  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  coachProfile  CoachProfile     @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
}

model ConversationThread {
  id               String                   @id @default(cuid())
  clientUserId     String
  coachUserId      String
  coachProfileId   String
  status           ConversationThreadStatus @default(open)
  subject          String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  lastMessageAt    DateTime?
  lockedReason     String?
  clientUser       User                     @relation("ConversationThreadClient", fields: [clientUserId], references: [id], onDelete: Cascade)
  coachUser        User                     @relation("ConversationThreadCoachUser", fields: [coachUserId], references: [id], onDelete: Cascade)
  coachProfile     CoachProfile             @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  participants     ConversationParticipant[]
  messages         ConversationMessage[]
  attachments      ConversationMessageAttachment[]
  readCursors      ConversationReadCursor[]
  reports          ConversationReport[]

  @@unique([clientUserId, coachProfileId])
  @@index([coachUserId, lastMessageAt])
  @@index([clientUserId, lastMessageAt])
}

model ConversationParticipant {
  id                  String             @id @default(cuid())
  threadId            String
  userId              String
  role                String
  isActive            Boolean            @default(true)
  joinedAt            DateTime           @default(now())
  thread              ConversationThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model ConversationMessage {
  id                  String             @id @default(cuid())
  threadId            String
  senderUserId        String?
  senderType          MessageSenderType
  body                String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  deletedAt           DateTime?
  thread              ConversationThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderUser          User?              @relation("ConversationMessageSender", fields: [senderUserId], references: [id], onDelete: SetNull)
  attachment          ConversationMessageAttachment?
  reports             ConversationReport[]

  @@index([threadId, createdAt])
}

model ConversationMessageAttachment {
  id                  String            @id @default(cuid())
  messageId           String            @unique
  threadId            String
  type                AttachmentType
  status              AttachmentStatus  @default(uploaded)
  fileName            String
  mimeType            String
  sizeBytes           Int
  storageKey          String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  validatedAt         DateTime?
  rejectedReason      String?
  message             ConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  thread              ConversationThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([status])
}

model ConversationReadCursor {
  threadId            String
  userId              String
  lastReadMessageId   String?
  lastReadAt          DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  thread              ConversationThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([threadId, userId])
}

model ConversationReport {
  id                  String              @id @default(cuid())
  threadId            String
  messageId           String?
  reporterUserId      String
  reason              String
  details             String?
  status              String              @default("open")
  createdAt           DateTime            @default(now())
  resolvedAt          DateTime?
  resolverUserId      String?
  thread              ConversationThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message             ConversationMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  reporterUser        User                @relation("ConversationReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([threadId, createdAt])
}

model QaQuestion {
  id                String            @id @default(cuid())
  slug              String            @unique
  title             String
  body              String
  authorUserId      String
  authorDisplayName String?
  isAnonymous       Boolean           @default(false)
  status            QaQuestionStatus  @default(published)
  topicSlug         String
  topicName         String
  categorySlug      String?
  citySlug          String?
  acceptedAnswerId  String?
  viewsCount        Int               @default(0)
  answersCount      Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  publishedAt       DateTime          @default(now())
  authorUser        User              @relation("QaQuestionAuthor", fields: [authorUserId], references: [id], onDelete: Cascade)
  tags              QaQuestionTagLink[]
  answers           QaAnswer[]        @relation("QaQuestionAnswers")
  reports           QaReport[]
  moderationLogs    QaModerationLog[]
  acceptedAnswer    QaAnswer?         @relation("QaQuestionAcceptedAnswer", fields: [acceptedAnswerId], references: [id], onDelete: SetNull)

  @@index([status, publishedAt])
  @@index([topicSlug, publishedAt])
  @@index([categorySlug, publishedAt])
  @@index([citySlug, publishedAt])
}

model QaQuestionTag {
  id        String             @id @default(cuid())
  slug      String             @unique
  name      String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  links     QaQuestionTagLink[]
}

model QaQuestionTagLink {
  questionId String
  tagId      String
  question   QaQuestion     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag        QaQuestionTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([questionId, tagId])
}

model QaAnswer {
  id                 String          @id @default(cuid())
  questionId         String
  authorUserId       String
  coachProfileId     String
  body               String
  status             QaAnswerStatus  @default(published)
  isAccepted         Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  question           QaQuestion      @relation("QaQuestionAnswers", fields: [questionId], references: [id], onDelete: Cascade)
  authorUser         User            @relation("QaAnswerAuthor", fields: [authorUserId], references: [id], onDelete: Cascade)
  coachProfile       CoachProfile    @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  votes              QaAnswerVote[]
  reports            QaReport[]
  moderationLogs     QaModerationLog[]
  acceptedForQuestion QaQuestion[]   @relation("QaQuestionAcceptedAnswer")

  @@index([questionId, createdAt])
  @@index([coachProfileId, createdAt])
}

model QaAnswerVote {
  id         String      @id @default(cuid())
  answerId    String
  userId      String
  voteType    QaVoteType
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  answer      QaAnswer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([answerId, userId])
  @@index([answerId, voteType])
}

model QaReport {
  id             String             @id @default(cuid())
  targetType      QaReportTargetType
  questionId      String?
  answerId        String?
  reporterUserId  String
  reason          String
  details         String?
  status          String             @default("open")
  createdAt       DateTime           @default(now())
  resolvedAt      DateTime?
  question        QaQuestion?        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer          QaAnswer?          @relation(fields: [answerId], references: [id], onDelete: Cascade)
  reporterUser    User               @relation("QaReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([targetType, createdAt])
}

model QaModerationLog {
  id            String      @id @default(cuid())
  questionId     String?
  answerId       String?
  actorUserId    String?
  action         String
  note           String?
  payload        Json?
  createdAt      DateTime   @default(now())
  question       QaQuestion? @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer         QaAnswer?   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  actorUser      User?       @relation("QaModerationActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([createdAt])
}

model Notification {
  id          String                   @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  body        String
  data        Json?
  isRead      Boolean                  @default(false)
  readAt      DateTime?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries  NotificationDeliveryAttempt[]

  @@index([userId, isRead, createdAt])
  @@index([type, createdAt])
}

model NotificationPreference {
  id         String              @id @default(cuid())
  userId     String
  type       NotificationType
  channel    NotificationChannel
  enabled    Boolean             @default(true)
  digestMode String              @default("instant")
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, channel])
}

model NotificationDeliveryAttempt {
  id             String                     @id @default(cuid())
  notificationId String
  userId         String?
  channel        NotificationChannel
  status         NotificationDeliveryStatus @default(pending)
  provider       String?
  providerMessageId String?
  errorMessage   String?
  attemptedAt    DateTime?
  createdAt      DateTime                   @default(now())
  notification   Notification               @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User?                      @relation("NotificationDeliveryUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([notificationId, channel])
}

model JobQueue {
  id           String     @id @default(cuid())
  type         JobType
  status       JobStatus  @default(queued)
  priority     JobPriority @default(normal)
  payload      Json?
  dedupeKey    String?
  scheduledAt  DateTime   @default(now())
  startedAt    DateTime?
  finishedAt   DateTime?
  lockedAt     DateTime?
  lockedBy     String?
  attempts     Int        @default(0)
  maxAttempts  Int        @default(5)
  lastError    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  runLogs      JobRunLog[]

  @@index([status, scheduledAt, priority])
  @@index([type, status])
}

model JobRunLog {
  id          String    @id @default(cuid())
  jobId       String
  actorUserId String?
  status      JobStatus
  note        String?
  errorMessage String?
  durationMs  Int?
  createdAt   DateTime  @default(now())
  job         JobQueue  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  actorUser   User?     @relation("JobRunActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([jobId, createdAt])
}

model AttributionSession {
  id             String      @id @default(cuid())
  sessionKey      String      @unique
  userId          String?
  firstLandingPath String?
  lastLandingPath String?
  referrerUrl     String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  ipHash          String?
  userAgentHash   String?
  firstTouchAt    DateTime    @default(now())
  lastTouchAt     DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  funnelEvents    FunnelEvent[]

  @@index([userId, updatedAt])
}

model FunnelEvent {
  id                  String           @id @default(cuid())
  attributionSessionId String?
  userId              String?
  coachProfileId      String?
  eventType           FunnelEventType
  sourcePath          String?
  metadata            Json?
  createdAt           DateTime         @default(now())
  attributionSession  AttributionSession? @relation(fields: [attributionSessionId], references: [id], onDelete: SetNull)
  user                User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  coachProfile        CoachProfile?    @relation(fields: [coachProfileId], references: [id], onDelete: SetNull)

  @@index([eventType, createdAt])
  @@index([coachProfileId, eventType, createdAt])
}

model CoachFunnelDailyAggregate {
  id             String     @id @default(cuid())
  coachProfileId  String
  date           DateTime   @db.Date
  counts         Json
  conversionRates Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  coachProfile   CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)

  @@unique([coachProfileId, date])
}

model PlatformFunnelDailyAggregate {
  id             String     @id @default(cuid())
  date           DateTime   @unique @db.Date
  counts         Json
  conversionRates Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}
